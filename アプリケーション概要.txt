Mixync（ミキシンク） - アプリケーション概要

================================================================================
1. アプリケーションの目的
================================================================================

Mixyncは、Fitbitの生体信号データと連携し、ユーザーの睡眠サイクルや心拍数パターンを分析して、パーソナライズされたアラームを提供するWebアプリケーションです。ユーザーの生体リズムに合わせた最適な起床時間の提案と、過去のデータに基づいた最適なアラーム音の選択を行います。

【機械学習AI機能 - Symphonia（シンフォニア）】
本アプリケーションでは、独自開発のAI「Symphonia（シンフォニア）」を搭載しています。
Symphoniaは、ユーザーの生体信号パターンを学習し、最適な目覚め体験を提供する推薦システムです。
以下の機能に機械学習・AI技術を活用しています：
★ マークが付いている機能がSymphoniaによる機械学習AI機能です。

================================================================================
2. 主要機能
================================================================================

2.1 ユーザー認証
--------------------------------------------------------------------------------
- 新規登録、ログイン、ログアウト機能
- JWT (JSON Web Token) ベースの認証システム
- セッション管理とPassport.jsによる認証フロー

2.2 Fitbit連携
--------------------------------------------------------------------------------
- OAuth2を使用したFitbitアカウントとの連携
- 睡眠データ（睡眠ログ、睡眠ステージ、REM睡眠サイクル）の自動取得
- 心拍数データ（イントラデイ心拍数）の取得とリサンプリング
- アクセストークンとリフレッシュトークンの自動管理

2.3 睡眠サイクル分析 ★【機械学習AI】
--------------------------------------------------------------------------------
- REM睡眠サイクルの検出: Fitbitから取得した睡眠ステージデータから、REM睡眠の間隔を分析し、ユーザー固有の平均睡眠サイクル時間を算出
- おすすめ起床時間の提案: 就寝時刻を入力すると、睡眠サイクル（デフォルト90分、またはユーザーの平均サイクル）に基づいて、4サイクル、5サイクル、6サイクル後の最適な起床時間を提案

2.4 アラーム管理
--------------------------------------------------------------------------------
- アラームのCRUD操作: アラームの作成、読み取り、更新、削除
- 曜日指定: 特定の曜日にのみアラームを鳴らす設定が可能
- ON/OFF切り替え: アラームの有効/無効を簡単に切り替え
- ミキシングパターン選択: 
  * AUTO ★【Symphonia AI】: 過去の履歴とDTW（Dynamic Time Warping）類似度分析に基づいて自動選択
  * A, B, C: 手動で特定のアラーム音パターンを選択

2.5 アラーム音ファイル管理
--------------------------------------------------------------------------------
- WAVファイルのアップロード: ユーザーが独自のアラーム音をアップロード可能
- アラーム音の削除: 不要なアラーム音を削除
- アラーム音の一覧表示: 登録済みのアラーム音を確認

2.6 データ可視化
--------------------------------------------------------------------------------
データ可視化コンポーネントでは、3つの異なる視点からアラーム履歴データを分析・表示します：

① 覚醒速度（Awakening HR Slope）の推移
  - 表示内容: アラーム鳴動後の心拍数の上昇速度（bpm/秒）を時系列で折れ線グラフ表示
  - 意味: 低い値ほど穏やかな目覚めを示す
  - データソース: alarm_eventsテーブルのawakening_hr_slopeフィールド

② ミキシングパターン別の比較
  - 表示内容: ミキシングA、B、Cそれぞれの平均快適度スコアと平均Slopeを棒グラフで比較
  - 意味: どのミキシングパターンが最も快適な目覚めをもたらすかを可視化
  - データソース: 
    * 平均快適度: comfort_scoreの平均値
    * 平均Slope: awakening_hr_slopeの平均値（×100でスケーリング）
    * 各ミキシングの使用回数も表示

③ 快適度スコアの推移
  - 表示内容: 快適度スコア（0-100点）の時系列推移を折れ線グラフで表示
  - 意味: 高い値ほど快適な目覚めを示す。時間経過とともに改善しているかを確認可能
  - データソース: alarm_eventsテーブルのcomfort_scoreフィールド

週間睡眠グラフ（SleepChart）
  - 表示内容: 過去7日間（日曜日～土曜日）の睡眠時間を棒グラフで表示
  - 機能: 
    * 週単位での前後移動が可能
    * Fitbitとの手動同期ボタン
    * ツールチップで「X時間Y分」形式で詳細表示
  - データソース: Fitbitから取得した睡眠ログデータ

2.7 アラーム履歴管理
--------------------------------------------------------------------------------
- 履歴一覧表示: 過去のアラーム鳴動イベントをリスト形式で表示
- 表示項目:
  * アラーム時刻
  * ミキシングパターン
  * 起床前平均心拍数（hr_avg_before）
  * 心拍数ピーク（hr_peak）
  * 覚醒速度（awakening_hr_slope）
  * 快適度スコア（comfort_score）
- 起床後データ計算機能: 
  * アラーム鳴動から30分後以降に「今日のデータを計算」ボタンが表示
  * Fitbit APIの15分のタイムラグを考慮した設計
  * 計算済みイベントには「計算済み」バッジを表示

2.8 評価とフィードバック ★【Symphonia AI】
--------------------------------------------------------------------------------
- アラーム後の評価入力: アラーム鳴動後に、気分評価（1-5）と音の評価（1-5）を入力
- 快適度スコアの自動計算: 気分評価と音の評価を組み合わせて、0-100の快適度スコアを算出
- DTW類似度分析 ★【Symphonia AI】: 過去のアラーム鳴動時の心拍数パターンと現在のパターンを比較し、最も類似した過去のイベントから最適なミキシングパターンを推薦
  * Dynamic Time Warping（DTW）アルゴリズムを使用した時系列パターンマッチング
  * Symphoniaによる類似度スコアに基づく推薦システム

2.9 リアルタイム通知
--------------------------------------------------------------------------------
- WebSocket通信: アラーム鳴動時にWebSocketを通じてフロントエンドにリアルタイム通知
- モーダル表示: アラームが鳴ると、フロントエンドにモーダルが表示され、アラーム音が再生される

================================================================================
3. 技術スタック
================================================================================

3.1 フロントエンド
--------------------------------------------------------------------------------
- フレームワーク: React 19.2.0
- ビルドツール: Vite 7.1.10
- UIライブラリ: Material-UI (MUI) 7.3.4
- ルーティング: React Router DOM 7.9.4
- グラフ描画: Chart.js 4.5.1 + react-chartjs-2 5.3.0
- モバイル対応: Capacitor 7.4.4（Androidアプリ化）

3.2 バックエンド (Node.js)
--------------------------------------------------------------------------------
- フレームワーク: Express 5.1.0
- データベース: SQLite3（better-sqlite3 12.4.6）
- 認証: Passport.js（passport-local、passport-fitbit-oauth2）
- JWT: jsonwebtoken 9.0.2
- セッション管理: express-session 1.18.2
- HTTP通信: axios 1.12.2
- WebSocket: ws 8.18.0
- ファイルアップロード: multer 1.4.5
- パスワードハッシュ化: bcrypt 6.0.0

3.3 バックエンド (Python)
--------------------------------------------------------------------------------
- フレームワーク: FastAPI
- 音響処理: Pedalboard（Reverb、PitchShift、Gain）
- 音声ファイル処理: soundfile
- データ分析: NumPy、pandas
- DTW類似度計算: dtaidistance（Dynamic Time Warping）

3.4 データベース構造
--------------------------------------------------------------------------------
- users: ユーザー情報（メール、パスワード、Fitbitトークン）
- alarms: アラーム設定（時刻、曜日、音ファイル、ミキシングパターン）
- sleep_logs: Fitbitから取得した睡眠ログ
- rem_cycle_intervals: REM睡眠サイクルの間隔データ
- alarm_events: アラーム鳴動履歴（心拍数パターン、評価、快適度スコア）

================================================================================
4. アーキテクチャ
================================================================================

4.1 システム構成
--------------------------------------------------------------------------------
┌─────────────────┐
│   Frontend      │  (React + Vite)
│   Port: 5173    │  - UI表示、ユーザー操作
└────────┬────────┘
         │ HTTP/WebSocket
         ▼
┌─────────────────┐
│  Backend (Node) │  (Express)
│   Port: 3001    │  - 認証、Fitbit連携、DB操作
└────────┬────────┘
         │ HTTP
         ▼
┌─────────────────┐
│ Backend (Python)│  (FastAPI)
│   Port: 8000    │  - 睡眠分析、DTW計算、覚醒指標計算
└─────────────────┘

4.2 主要なデータフロー
--------------------------------------------------------------------------------
アラーム鳴動フロー:
1. スケジューラー: Node.jsバックエンドが1分ごとにアラームをチェック
2. Fitbitデータ取得: アラーム鳴動前の心拍数データを取得
3. DTW分析: Pythonバックエンドで過去のパターンと比較し、最適なミキシングを推薦
4. WebSocket通知: フロントエンドにリアルタイム通知
5. アラーム再生: フロントエンドでアラーム音を再生
6. 評価入力: ユーザーが気分と音を評価
7. 履歴保存: 評価と心拍数データをalarm_eventsテーブルに保存

================================================================================
5. 主要なエンドポイント
================================================================================

5.1 認証関連 (/auth)
--------------------------------------------------------------------------------
- POST /auth/register: 新規ユーザー登録
- POST /auth/login: ログイン
- POST /auth/logout: ログアウト
- GET /auth/status: 認証状態確認
- GET /auth/fitbit: Fitbit OAuth開始
- GET /auth/fitbit/callback: Fitbit OAuthコールバック

5.2 Fitbit関連 (/api/fitbit)
--------------------------------------------------------------------------------
- GET /api/fitbit/sleep-logs: 睡眠ログ取得
- GET /api/fitbit/heart-rate: 心拍数データ取得
- GET /api/fitbit/sleep/week/:date: 週間睡眠データ取得
- POST /api/fitbit/sleep/sync: Fitbitとの手動同期

5.3 アラーム関連 (/api/alarms)
--------------------------------------------------------------------------------
- GET /api/alarms: アラーム一覧取得
- POST /api/alarms: アラーム作成
- PUT /api/alarms/:id: アラーム更新
- DELETE /api/alarms/:id: アラーム削除

5.4 イベント関連 (/api/events)
--------------------------------------------------------------------------------
- GET /api/events: アラーム履歴イベント一覧取得

5.5 アラーム処理関連 (/api/alarm)
--------------------------------------------------------------------------------
- POST /api/alarm/post-process: 起床後データの計算（心拍数ピーク、回復時間など）

5.6 Python処理関連
--------------------------------------------------------------------------------
- POST /analyze-sleep-cycle: 睡眠サイクル分析
- POST /calculate-awakening-metrics: 覚醒指標計算
- POST /calculate-dtw-similarity: DTW類似度計算
- POST /recommend-mixing: ミキシングパターン推薦

================================================================================
6. 特徴的な機能
================================================================================

6.1 パーソナライズされたアラーム ★【Symphonia AI】
--------------------------------------------------------------------------------
Symphoniaがユーザーの過去のアラーム履歴と心拍数パターンを学習し、最も快適に目覚められるアラーム音を自動選択
- 履歴データからのパターン学習
- 快適度スコアに基づく最適化
- 個人に合わせた推薦システム

6.2 生体信号ベースの分析
--------------------------------------------------------------------------------
Fitbitの心拍数データをリアルタイムで分析し、覚醒時の心拍数傾斜（slope）や標準偏差（stddev）を計算
- 覚醒速度の定量化
- 心拍数パターンの抽出と保存
- Symphoniaの学習データとして活用

6.3 DTW（Dynamic Time Warping）による類似度分析 ★【Symphonia AI】
--------------------------------------------------------------------------------
Symphoniaのコア技術：時系列データの形状を比較し、過去の類似したパターンから最適な設定を推薦
- DTWアルゴリズムによる時系列パターンマッチング
- 類似度スコア（0-1）の計算
- 類似度閾値（0.8以上）による高精度フィルタリング
- 上位類似イベントからの推薦生成

6.4 モバイル対応
--------------------------------------------------------------------------------
Capacitorを使用してAndroidアプリとして動作可能
ネイティブブラウザでFitbit認証を処理

================================================================================
7. 今後の拡張可能性
================================================================================

- iOS対応: Capacitorを使用してiOSアプリ化
- HRV（心拍変動）分析: より詳細なストレス状態の分析
- 機械学習モデルの導入: より高度なパーソナライゼーション
- 複数アラーム音のブレンド: 複数の音源を組み合わせた動的生成
- スマートウォッチ連携: Apple WatchやGarminなど他のデバイスとの連携

================================================================================

================================================================================
まとめ
================================================================================

Mixync（ミキシンク）は、生体信号データと独自開発のAI「Symphonia（シンフォニア）」を活用した次世代のスマートアラームシステムです。

【Symphonia AI技術の特徴】
Symphoniaは、ユーザーの生体信号パターンを継続的に学習し、個人に最適化された目覚め体験を提供します：

- DTW（Dynamic Time Warping）による時系列パターンマッチング
- 過去データからの学習による高精度な推薦システム
- REM睡眠サイクルの自動検出と分析
- 個人の快適度スコアに基づく最適なアラーム音の自動選択
- 使えば使うほど精度が向上する適応型学習システム

Symphoniaの機械学習技術により、ユーザーの睡眠の質と目覚めの快適さを継続的に向上させることを目指しています。
