# プロジェクト詳細要件定義書：Mixync (旧 BioMixer)

このドキュメントは、**「Mixync (BioMixer)」** というアプリケーションの全仕様、アーキテクチャ、ロジック詳細を網羅したものです。
他のAIアシスタントや開発者がこのプロジェクトを完全に理解し、再現・拡張できるように記述されています。

---

## 1. プロジェクト概要

### **コンセプト**
**「生体データに基づく適応的起床支援システム (AI-Powered Adaptive Awakening Support System)」**
既存のアラーム（固定音）では、ユーザーの睡眠深度や自律神経の状態を考慮できないため、「不快な目覚め（睡眠慣性）」を引き起こすことがあります。
本システムは、**Fitbit** から取得したリアルタイムの心拍変動データを解析し、AIが「その人の今の状態」に最適な音響エフェクト（トレモロ、コーラス等）を動的に生成・再生することで、快適な覚醒を誘導します。

### **独自性**
*   **動的ミキシング:** 音量やテンポを変えるだけでなく、**音色そのもの（エフェクト）** を生体反応に合わせて作り変える。
*   **DTWアルゴリズム:** 過去の「良い目覚め」の波形パターンを記憶し、類似した朝には同じ音を再現する学習機能。
*   **比較実験機能:** 従来の固定音とAI生成音の効果を定量的に比較するための実験モードを搭載。

---

## 2. システムアーキテクチャ

### **全体構成**
本システムは、**モバイルアプリ（フロントエンド）**、**VPSサーバー（バックエンド）**、**外部API（Fitbit）** の3要素で構成されます。

1.  **フロントエンド (Android App):**
    *   ユーザーインターフェース。アラーム設定、音声再生、Fitbit認証を行う。
2.  **バックエンド (Node.js):**
    *   全体の指揮官（オーケストレーター）。APIリクエスト処理、DB管理、スケジュール実行を担当。
3.  **AIエンジン (Python):**
    *   計算担当。信号処理、DTWマッチング、オーディオ合成（WAV生成）を行う。
4.  **インフラ (Xserver VPS):**
    *   Nginx (SSL/リバースプロキシ)、PM2 (プロセス管理) で稼働。

### **技術スタック**

| カテゴリ | 技術・ライブラリ | 用途 |
| :--- | :--- | :--- |
| **Frontend** | React, Vite | UI構築 |
| | Capacitor | Androidアプリ化 (APK生成) |
| | Material UI (MUI) | デザインシステム ("Deep Purple" Dark Theme) |
| | Recharts, Canvas | データ可視化、背景アニメーション (Shooting Stars) |
| **Backend** | Node.js (Express) | APIサーバー |
| | SQLite (better-sqlite3) | データベース |
| | node-cron | 定期実行タスク管理 |
| **AI / Audio** | Python (FastAPI) | AIロジックサーバー |
| | Pedalboard (by Spotify) | 高品質オーディオエフェクト処理 |
| | NumPy, SciPy, FastDTW | 数値解析、波形マッチング |
| **DevOps** | Git, PM2 | バージョン管理、プロセス永続化 |

---

## 3. アプリケーションロジック詳細

### **A. データフロー（起床までの流れ）**

1.  **アラーム設定:** ユーザーがアプリで時刻（例: 7:00）を設定。
2.  **Pre-Process (6:45 - 15分前):**
    *   サーバーが自動起動。Fitbit APIを叩き、直近30分間の **心拍数（Intraday Heart Rate: 1秒/5秒間隔）** を取得。
    *   まだFitbitサーバーにデータが同期されていない場合は、デフォルト設定（Pattern A）にフォールバック。
3.  **Analysis (解析):**
    *   Node.jsが取得した心拍データをPythonサーバーへ送信。
    *   Python側で以下の特徴量を算出：
        *   平均心拍数、分散 (StdDev)、ピーク値
        *   睡眠段階（Sleep Stage: REM, Light, Deep）※APIから取得可能な場合
4.  **Recommendation (AI推論):**
    *   **DTW (Dynamic Time Warping)** アルゴリズムを使用。
    *   「現在の心拍波形」と「過去の成功データ（Comfort Scoreが高かった日）」を比較。
    *   最も波形が似ている過去の事例を特定し、その時に使われたミキシングパターン（A〜E）を推奨候補とする。
5.  **Audio Generation (音声合成):**
    *   決定されたパターン（例: Pattern B = Auto-Pan）に基づき、原音ファイルにエフェクトを適用。
    *   加工されたWAVファイルを生成し、静的ファイルとして公開。
6.  **Playback (7:00 - 起床):**
    *   アプリがポーリングで「準備完了」検知。音声をダウンロードして再生。
    *   ユーザーが「起きる（Stopボタン）」を押すまでループ再生。
7.  **Feedback (事後評価):**
    *   起床後、ユーザーが「気分」と「目覚めの良さ」を入力。
    *   システムがこれをスコア化 (0-100) し、次回の学習データとして保存。

### **B. 実験プロトコル（4日サイクル）**
本番運用では、効果検証のために以下の厳密なルールで動作します。

*   **サイクル:** 4日ごとにミキシングパターンを固定で切り替える（計20日間）。
    *   Day 1-4: Pattern A
    *   Day 5-8: Pattern B
    *   ...
    *   Day 17-20: Pattern E
*   **判定ロジック:**
    *   アラーム完了数（`COUNT`）を4で割った商でパターンを決定。
    *   `math.floor(count / 4)` → 0ならA, 1ならB...

---

## 4. データベース設計 (SQLite)

### **主なテーブル定義**

1.  **users**
    *   ユーザー情報、Fitbitアクセストークン/リフレッシュトークンを管理。
    *   複数のFitbitアカウント（自分用・協力者用）を分離可能。

2.  **alarms**
    *   アラーム設定（時刻、有効/無効）。
    *   `is_deleted`: 論理削除フラグ（誤操作によるデータ消失防止）。

3.  **alarm_events** (最重要)
    *   1回のアラーム起動ごとの詳細記録。
    *   `alarm_time`: 設定時刻
    *   `rang_at_jp`: 実際に鳴った時刻
    *   `mixing_pattern`: 適用されたパターン (A, B, C, D, E)
    *   `hr_pattern_before`: 起床前の心拍波形（JSON配列）
    *   `comfort_score`: 覚醒品質スコア (0-100)

---

## 5. ミキシングパターンの定義

Python (Pedalboard) で実装されている5つの音響効果です。

*   **Pattern A: Tremolo (トレモロ)**
    *   音量を低周波で揺らす。注意喚起効果が高い。
*   **Pattern B: Auto-Pan (オートパン)**
    *   音を左右のチャンネル間で移動させる。空間的な広がりで覚醒を促す。
*   **Pattern C: Shimmer Reverb (シマーリバーブ)**
    *   原音の1オクターブ上の音を残響として付加。高周波成分で爽快感を出す。
*   **Pattern D: Delay (ディレイ)**
    *   リズムカルな反響音を付加。予測不可能なリズムで脳を刺激する。
*   **Pattern E: Chorus (コーラス)**
    *   微細なピッチズレを持つ音を重ねる。音に厚みを持たせ、心地よい覚醒を狙う。

---

## 6. ディレクトリ構成

*   `/frontend` - Reactアプリ (Vite)
    *   `/src/components` - UIコンポーネント (ShootingStars, AlarmCardなど)
    *   `/android` - Capacitor用Androidプロジェクト
*   `/backend-node` - Node.js APIサーバー
    *   `/routes` - エンドポイント (alarm-process.js, fitbit.jsなど)
    *   `/lib` - DB接続、共通ロジック
*   `/backend-python` - Python AIサーバー
    *   `main.py` - FastAPIエントリーポイント
    *   `audio_processor.py` - 音響処理ロジック
    *   `dtw_engine.py` - AI推奨ロジック

---

## 7. 特記事項 (開発中の工夫)

*   **安全性 (Safety):** アルゴリズムのバグや誤操作でデータが消えないよう、DB操作は「論理削除 (Soft Delete)」を徹底しています。
*   **分離環境 (Isolation):** 開発者と協力者のデータが混ざらないよう、サーバーポート (3001/3002) とデータベースファイル (`biomixer.db`/`biomixer-collab.db`) を完全に分離して運用しています。
*   **SSL対応:** Fitbit APIのリダイレクト要件を満たすため、NginxとLet's Encryptで完全なHTTPS化を行っています。
